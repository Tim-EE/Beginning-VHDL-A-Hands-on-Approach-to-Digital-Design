# Using GHDL and GTKWave

## Introduction

While any VHDL simulator can be used to simulate these designs, we will use an open-source process to simulate and view the results.

http://ghdl.free.fr[GHDL] is an open source VHDL simulator that we can use to simulate the code that we developed earlier. We can use this simulator to generate a value-change dump (VCD) file. A VCD file captures the value of signals within the design and the times during the simulation that they change. This VCD file can be viewed using another open source software called http://gtkwave.sourceforge.net/[GTKWave].

The GHDL/GTKWave flow is shown in <<fig:ghdl_gtkwave_flow>>.

.GHDL is used to compile, evaluate, and simulate a design, creating a VCD that can be viewed by GTKWave.
[#fig:ghdl_gtkwave_flow,pdfwidth=5in]
image::ghdl_gtkwave_flow.svg[GHDL/GTKWave Flow,50%]

## Using GHDL to Simulate the Design

To simulate a design with GHDL, we need to:

1. *Analyze the design:* converts the source code into a form that GHDL can evaluate.
2. *Evaluate the design:* creates a program that can be run by the computer.
3. *Run the simulation:* executes the evaluated design and generates waveforms.

To perform each of these steps, GHDL is called with different flags: `-a` to analyze, `-e` to evaluate, and `-r` to run the simulation.

### Analyzing Files with GHDL

The first step to simulate with GHDL is to analyze all of the source files needed for the design.

The GHDL command to analyze source file(s) is:

```
$ ghdl -a <source file(s)>
```

In the case of the half adder testbench, the following files have to be analyzed by GHDL:

* ANDGATE.vhd
* XORGATE.vhd
* HALF_ADDER.vhd
* HALF_ADDER_TB.vhd

To analyze the files, we can either call GHDL for each file or specify each of the files on the same line:

```
$ ghdl -a ANDGATE.vhd XORGATE.vhd HALF_ADDER.vhd HALF_ADDER_TB.vhd
```

or, we can also do:

```
$ ghdl -a ANDGATE.vhd
$ ghdl -a XORGATE.vhd
$ ghdl -a HALF_ADDER.vhd
$ ghdl -a HALF_ADDER_TB.vhd
```

Whichever method we choose, we should end up with a file, `work-obj93.cf`, which describes the library `work`. This `work` library will contain the designs for each of the files analyzed.


### Evaluating Designs with GHDL

The second step when using GHDL is to perform an evaluation of the design analyzed in the first step.

NOTE: These two steps, analysis and evaluation, might seem a little odd until you realize GHDL is actually creating machine code that runs on your machine!

Similar to the analysis step, each of the files must be evaluated using nearly the same command as before, just with `-e` instead of `-a` and using the design name to evaluate:

```
$ ghdl -e ANDGATE
$ ghdl -e XORGATE
$ ghdl -e HALF_ADDER
$ ghdl -e HALF_ADDER_TB
```

NOTE: The evaluation of the designs (`-e`) should use the same flags as during the analysis phase (`-a`).

### Simulating a Design with GHDL

Once the design and all underlying designs have been analyzed and evaluated, the final step for GHDL is to run the simulation.

To run a simulation, we call GHDL with the `-r` flag:

```
$ ghdl -r <design unit> --vcd=<VCD file name> [--stop-time=<time to stop>]
```

For our half adder testbench, we can use the following command:

```
$ ghdl -r half_adder_tb --vcd=half_adder_signals.vcd --stop-time=20ns
```

This command tells GHDL to run a simulation using the `half_adder_tb` design unit, to generate a VCD output named 'half_adder_signals.vcd', and to run the simulation for 20ns.

After running this command (if you are simulating a large design, it may take some time), we should have the 'half_adder_signals.vcd' file in the directory.

This VCD file contains the signals, their values, and when they changed during the simulation. To view these waveforms, we will use GTKWave.

## Using GTKWave to View the Simulation Results

GTKWave is used here to import the VCD file generated by GHDL during the simulation run and display the signals used in the design.

<<fig:gtkwave_annotated>> shows the main window of GTKWave.

.The GTKWave main window.
[#fig:gtkwave_annotated,pdfwidth=100%]
image::gtkwave_annotated.svg[GTKWave Main Window,50%]

To use GTKWave to view the signals, we need to:

1. Load the VCD file with the signals to view
2. Select the signals to view from the signal search tree (SST).
3. 'Append' or 'Insert' the selected signals from the SST.
4. Verify the signals have been added to the 'Signals' window and are visible in the waveform viewing window.


Once the waveforms have been loaded, the cursor can be used to view the values of each of the signals at that point in time.
